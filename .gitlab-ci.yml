default:
  image: 
    name: hashicorp/terraform
    entrypoint: [""]
  timeout: 15 minutes

stages:
  - format
  - init
  - validate
  - generate_ssh_keys
  - apply
  - destroy

format:
  stage: format
  script:
    - terraform fmt

download_provider:
  stage: init
  script:
    - terraform init

validate:
  stage: validate
  script:
    - terraform validate

generate_ssh_keys:
  stage: generate_ssh_keys
  image: 
    name: kunchalavikram/ssh-keygen
    entrypoint: [""]
  script:
    - ssh-keygen -t rsa -f ./gitlab -q -P ""
  artifacts:
    paths:
      - gitlab

.apply_configuration:
  stage: apply
  script:
    - terraform apply -auto-approve
  artifacts:
    paths:
      - hosts

.destroy_infra:
  stage: destroy
  script:
    - terraform destroy -auto-approve